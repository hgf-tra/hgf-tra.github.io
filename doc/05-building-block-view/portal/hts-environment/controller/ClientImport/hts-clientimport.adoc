== HTS Client Import - Level 5


## Introduction and Goals

### Purpose
Provide an outline for the CSV file import system that is focused on test takers and their test results.
This functionality is encapsulated in the Class `ClientImport`.
The primarily relevant data structure is `Client`.

(See xref:../../../../../08-concepts/concepts.adoc[concepts] for a description of the data structures.)



#### Use cases

[options="header"]
|===================================================================================================
| *Use case*                      | *Entry point* | *Synchronous?*
| Import of test takers           | Test takers view           | Yes
| Import of test results          | Test battery view          | Yes, but user confirmation required.
|===================================================================================================


## Requirements
* Input File
** Encoding: UTF-8
** CSV format
*** No headings
*** Separator: Semicolon (`;`)
** Separate areas within the CSV file
*** Configuration (optional depending on use case)
*** Client data
*** Separation Marker (optional depending on use case)
*** Test result data (optional depending on use case)

### Fields
#### Client Data Fields
[options="header"]
|=======================================================================================================
| *Field*             | *Mandatory* | *Data Type*  | Min Length | Max Length      | Notes
| firstName           | No          | Alphanumeric | 0          | 40      |
| lastName            | Yes (*)     | Alphanumeric | 0 (*)      | 40      | Either name or iCode MUST be given.
| iCode               | Yes (*)     | Alphanumeric | 0 (*)      |       | Unique ID
| birthday            | Yes         | String       | 0          | 8      | Can be a date or an age. Date must be given as dd.MM.yyy, age must be alphanumeric.
| sexString           | Yes         | String       | 1          | 1       |
| email               | No          | Integer      |           |       |
| clientGroupName     | No          | String       |           |       | If set, the group name must be known in advance, cannot be created during import.
| clientCategoryName  | No          | String       |           |       | If set, the category must be known in advance, cannot be created during import.
|=======================================================================================================



#### Test Result Data Fields

TO BE ADDED


#### Separation of Client and Test Result data within the file
If both clients and test results are to be imported, a *#configuration* block must be set at the start at the file to determine the test.
The test taker and test result must then follow in a *#data* block.

Furthermore, a fixed String literal *ASSESSMENT_RESPONSES*
must be present in each line within the CSV file to separate the Client import data (before) from the Client's test result data (after).




## Building Blocks / Class Structure
[width="100%",cols="12%,88%",options="header",]
|===
|Building Block |Short Description
| `loadClientImportFile(..)`, `readImportFile(..)`| Reads CSV file and separates into import lines
| `validateClient(..)` | Format validation
| `importClientsWithResponses()`| Import of test takers including test results
| `importClientsOnly(..)` | Import without test results
| `createClient(..)` | Create `Client` object, split import line into fields, try to read existing Client (by iCode) from db, fill fields from import line into `Client` object
| `importClient(..)` | Persistence of created `Client` object; handles update or add after Client creation
| `hasErrors(..)` | Errors during import are present IFF `errors`array is non-empty

|CreateClient | Creates Client object from imported line
|===


#### Update Behavior
##### Clients
* Re-importing a test taker with the same `iCode` updates the existing entry (`Client.update()`).
** If a to-be-imported test taker's `iCode` is found on the db, its db `ID` is set in the created `Client` object.
* Otherwise, a new `Client` is created (`Client.add()`).
** Add or update is decided within the method `importClient(..)` via the presence of a db `ID` within the created `Client` object.

* In the case of an update, optional fields that were already present on the DB but are not contained in the import line causing the update will remain with their original values.

##### Test results
* No update functionality.

#### User Actions
** The import process is initiated by the user selecting a local file through a UI action. +
Whether the import is  synchronous depends on the use case:
*** Client Import (not test results): Import is synchronous with user action "open file".
*** Import of test results: Import has to be confirmed by user. Selecting file triggers a preparation stage.


=== Validation

===== Client import

* For the optional fields "email", "clientGroupName" and "clientCategoryName", the input line does not need to contain the corresponding separators.
* In the case of validation errors, the error messages are collected in an `errors` array. (The same array is used for file IO errors.)

=== Quality/Performance Characteristics

* The client import blocks the UI during import.
* For large files / mass imports, preferably use HSI.

=== Directory/File Location

* xref:../hts-controller.adoc[hts-controller]
